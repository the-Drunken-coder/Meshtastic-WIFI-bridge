name: Publish to npm

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Optional dist-tag (e.g. latest, next)"
        required: false
        default: "latest"

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          registry-url: "https://registry.npmjs.org"

      - name: Resolve next version
        run: |
          node -e "const fs=require('fs');const {execSync}=require('child_process');const current=require('./package.json').version||'0.0.0';let latest='0.0.0';try{latest=execSync('npm view meshtastic-bridge version',{stdio:['ignore','pipe','ignore']}).toString().trim()||'0.0.0';}catch(e){};const pick=(a,b)=>{const pa=a.split('.').map(n=>parseInt(n,10)||0);const pb=b.split('.').map(n=>parseInt(n,10)||0);for(let i=0;i<3;i++){if(pb[i]>pa[i])return b;if(pb[i]<pa[i])return a;}return a;};const base=pick(current,latest);const parts=base.split('.').map(n=>parseInt(n,10)||0);parts[2]+=1;const next=parts.join('.');fs.appendFileSync(process.env.GITHUB_ENV,'NEXT_VERSION='+next+'\\n');console.log('Next version: '+next);"

      - name: Set version
        run: npm version "${{ env.NEXT_VERSION }}" --no-git-tag-version

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "chore: bump version to ${{ env.NEXT_VERSION }}"
          git push origin "HEAD:${GITHUB_REF_NAME}"

      - name: Publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public --tag "${{ inputs.tag }}"
